### Step-by-Step Playbook: Configure SSH MaxAuthTries to 4

#### **Objective**:  
Ensure the SSH server configuration (`sshd_config`) sets `MaxAuthTries` to `4` or lower to mitigate brute-force attacks.

---

### **Step 1: Pre-Check Backup**
1. **Backup the existing configuration file**:
   ```bash
   sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
   ```
   *Rationale*: Safeguard against accidental misconfiguration.

---

### **Step 2: Verify Current Live Configuration**
1. **Check the effective `MaxAuthTries` value**:
   ```bash
   sudo sshd -T | grep -i "maxauthtries"
   ```
   - **Expected Output**: `maxauthtries 4` (or lower).
   - If the value is `>4`, proceed to remediation.

---

### **Step 3: Inspect the Configuration File**
1. **Check `/etc/ssh/sshd_config` for explicit settings**:
   ```bash
   sudo grep -iP "^\s*MaxAuthTries\s+\d+" /etc/ssh/sshd_config
   ```
   - **Expected Output**: `MaxAuthTries 4` (or no output if unset).
   - If the value is `>4` or missing, proceed to remediation.

---

### **Step 4: Remediate Configuration**
1. **Edit `/etc/ssh/sshd_config`**:
   ```bash
   sudo nano /etc/ssh/sshd_config
   ```
   - **Case 1: Parameter Exists**  
     Locate the line `MaxAuthTries <value>`.  
     Change it to:  
     ```
     MaxAuthTries 4
     ```
   - **Case 2: Parameter Missing**  
     Add the line to any section (typically under `Authentication`):  
     ```
     MaxAuthTries 4
     ```
   - **Case 3: Parameter Commented Out**  
     Uncomment the line (remove `#`) and set the value:  
     ```
     #MaxAuthTries 6 → MaxAuthTries 4
     ```

2. **Remove duplicate entries** (if any):  
   Ensure only one `MaxAuthTries` directive exists unless using `Match` blocks.

---

### **Step 5: Validate Syntax Before Restarting SSH**
1. **Check for syntax errors**:
   ```bash
   sudo sshd -t
   ```
   - **Success**: No output.  
   - **Failure**: Address any reported errors (e.g., typos).

---

### **Step 6: Restart SSH Service**
1. **Apply the new configuration**:
   ```bash
   sudo systemctl restart sshd
   ```
   - **Note**: If connected via SSH, ensure a backup session is open to avoid lockouts.

---

### **Step 7: Post-Check Verification**
1. **Confirm the live value**:
   ```bash
   sudo sshd -T | grep -i "maxauthtries"
   ```
   - **Expected Output**: `maxauthtries 4`.

2. **Recheck the configuration file**:
   ```bash
   sudo grep -i "MaxAuthTries" /etc/ssh/sshd_config
   ```
   - **Expected Output**: `MaxAuthTries 4`.

---

### **Step 8: Logging and Documentation**
1. **Document the change**:
   - Record the date, time, and changes made.
   - Example:  
     ```
     2023-10-05: Set MaxAuthTries to 4 in /etc/ssh/sshd_config to comply with security policy.
     ```

---

### **Rollback Plan**
1. **Restore the backup** (if issues arise):
   ```bash
   sudo cp /etc/ssh/sshd_config.bak /etc/ssh/sshd_config
   sudo systemctl restart sshd
   ```

---

### **Additional Notes**
- **Lockout Prevention**: Test authentication in a new session before closing existing connections.
- **Site Policy**: Adjust the value (e.g., `4` → `3`) if required by organizational policy.
- **Match Blocks**: If `MaxAuthTries` is nested in a `Match User` or `Match Group` block, ensure it does not override the global setting unintentionally.

---

**Final Validation**:  
The live SSH configuration and `sshd_config` file must both reflect `MaxAuthTries 4` (or lower).