# Playbook: Restrict `su` Command Usage and Enforce `sudo` via PAM Configuration

## **Objective**
Restrict the `su` command to an empty group, ensuring privileged access is managed through `sudo` for better auditing and control.

---

## **1. Pre-Remediation Checks**

### **1.1 Verify Current PAM Configuration**
- **Command**:  
  ```bash
  grep -E 'auth\s+required\s+pam_wheel.so' /etc/pam.d/su
  ```
- **Expected Output**:  
  `auth required pam_wheel.so use_uid group=sugroup`  
  (Replace `sugroup` with the actual group name if different.)
- **Outcome**:  
  - If the line exists **and is uncommented**: Proceed to Step 1.2.  
  - If the line is **commented** (starts with `#`) or **missing**: Proceed to Remediation Steps.

---

### **1.2 Check if the Specified Group Exists**
- **Command**:  
  ```bash
  getent group sugroup
  ```
  (Replace `sugroup` with the group name from the PAM configuration.)
- **Expected Output**:  
  `sugroup:x:[GID]:` (No users listed after the GID.)
- **Outcome**:  
  - If the group **does not exist**: Proceed to Step 2.1.  
  - If the group **exists but has members**: Proceed to Step 2.3.  
  - If the group **exists and is empty**: Configuration is compliant.

---

## **2. Remediation Steps**

### **2.1 Create the SU Restriction Group**
- **Command**:  
  ```bash
  sudo groupadd sugroup
  ```
  (Replace `sugroup` with a group name per site policy.)

---

### **2.2 Configure PAM to Restrict `su`**
1. **Backup the PAM Configuration File**:  
   ```bash
   sudo cp /etc/pam.d/su /etc/pam.d/su.bak
   ```
2. **Edit `/etc/pam.d/su`**:  
   - Uncomment or add the following line:  
     ```
     auth required pam_wheel.so use_uid group=sugroup
     ```
   - Use `sudo vi /etc/pam.d/su` or a text editor of choice.  
   - **Example**:  
     ```bash
     sudo sed -i '/pam_wheel.so/s/^#//g' /etc/pam.d/su  # Uncomment if already present
     sudo sed -i 's/^auth.*pam_wheel\.so.*$/auth required pam_wheel.so use_uid group=sugroup/' /etc/pam.d/su  # Update parameters
     ```

---

### **2.3 Ensure the Group is Empty**
- **List Current Members**:  
  ```bash
  sudo getent group sugroup
  ```
- **Remove Existing Members** (if any):  
  ```bash
  sudo gpasswd -d [username] sugroup
  ```
  Repeat for all users in the group.

---

### **2.4 Verify `sudo` is Configured**
- Ensure users requiring privileged access are configured in `/etc/sudoers` or under `/etc/sudoers.d/`.  
  Example:  
  ```bash
  sudo visudo -f /etc/sudoers.d/admin-users
  ```

---

## **3. Post-Remediation Validation**

### **3.1 Confirm PAM Configuration**
- **Command**:  
  ```bash
  grep 'pam_wheel.so' /etc/pam.d/su
  ```
- **Expected Output**:  
  `auth required pam_wheel.so use_uid group=sugroup`.

---

### **3.2 Validate Group Membership**
- **Command**:  
  ```bash
  getent group sugroup
  ```
- **Expected Output**:  
  No users listed (e.g., `sugroup:x:1005:`).

---

### **3.3 Test `su` Restriction**
- **As a Non-Group User**:  
  ```bash
  su - root  # Should fail with "Permission denied"
  ```
- **As a Group User** (if temporarily added for testing):  
  ```bash
  su - root  # Should succeed
  ```

---

## **4. Optional Notes**
- **Custom Group Name**: Replace `sugroup` with a group name per organizational policy.  
- **Logging**: Confirm `sudo` logs are monitored (typically in `/var/log/secure` or `/var/log/auth.log`).  
- **Automation**: Use tools like Ansible or Puppet to enforce this configuration across systems.

---

**Final Output**:  
A system where only users in the empty `sugroup` (effectively no one) can execute `su`, forcing privileged access through `sudo`.