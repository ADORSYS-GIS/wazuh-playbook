### Step-by-Step Playbook: Configuring GRUB Boot Loader Password
#### **Objective**
Secure the GRUB boot loader by setting a password to prevent unauthorized modifications to boot parameters, while allowing unrestricted boot if required.
---
### **1. Pre-Configuration Checks**
**Purpose**: Verify existing GRUB configuration and prepare for changes.
1. **Backup Critical Files**
   ```bash
   sudo cp /etc/grub.d/10_linux /etc/grub.d/10_linux.bak
   sudo cp -r /boot/grub /boot/grub.bak
   ```
2. **Check Existing GRUB Password**
   ```bash
   sudo grep -E 'set superusers|password_pbkdf2' /boot/grub/grub.cfg
   ```
   - If output shows `superusers` or `password_pbkdf2`, a password is already configured.
---
### **2. Generate PBKDF2 Password Hash**
**Purpose**: Create an encrypted password for GRUB.
1. **Run Password Generator**
   ```bash
   grub-mkpasswd-pbkdf2
   ```
   - Follow prompts to enter and re-enter a password.
   - **Example Output**:
     ```
     PBKDF2 hash of your password is grub.pbkdf2.sha512.10000.ABC123...
     ```
2. **Save the Hash**
   - Copy the full hash (e.g., `grub.pbkdf2.sha512.10000.ABC123...`).
---
### **3. Create Custom GRUB Configuration File**
**Purpose**: Define superusers and password without risking override during updates.
1. **Create `/etc/grub.d/40_custom`**
   ```bash
   sudo nano /etc/grub.d/40_custom
   ```
2. **Add Configuration**
   Replace `<username>` and `<encrypted-password>` with your values:
   ```grub
   #!/bin/sh
   exec tail -n +3 $0
   set superusers="<username>"
   password_pbkdf2 <username> <encrypted-password>
   ```
3. **Make the File Executable**
   ```bash
   sudo chmod +x /etc/grub.d/40_custom
   ```
---
### **4. (Optional) Enable Unrestricted Boot Entries**
**Purpose**: Allow specific boot entries (e.g., default OS) to skip password prompts.
1. **Edit `/etc/grub.d/10_linux`**
   ```bash
   sudo nano /etc/grub.d/10_linux
   ```
2. **Modify the `CLASS` Line**
   Locate the line starting with `CLASS=` and add `--unrestricted`:
   ```bash
   CLASS="--class gnu-linux --class gnu --class os --unrestricted"
   ```
---
### **5. Update GRUB Configuration**
**Purpose**: Apply changes to the bootloader.
1. **Run `update-grub`**
   ```bash
   sudo update-grub
   ```
   - This regenerates `/boot/grub/grub.cfg`.
2. **Verify Updates**
   ```bash
   sudo grep -E 'set superusers|password_pbkdf2|--unrestricted' /boot/grub/grub.cfg
   ```
   - Ensure your username, password hash, and `--unrestricted` (if used) appear.
---
### **6. Post-Configuration Validation**
**Purpose**: Confirm the password is enforced.
1. **Reboot the System**
   ```bash
   sudo reboot
   ```
2. **Test GRUB Access**
   - During reboot, press `Esc`/`Shift` to enter GRUB menu.
   - Attempt to edit boot parameters (press `e`).
     - **Expected Result**: Prompt for username/password.
   - If `--unrestricted` was added:
     - Default boot entries should load without a password.
     - Recovery/advanced entries still require credentials.
---
### **Troubleshooting**
- **Forgotten Password**: Boot from a live USB/CD, chroot into the system, and remove the custom GRUB configuration.
- **GRUB Not Updated**: Ensure `/etc/grub.d/40_custom` is executable and rerun `update-grub`.
- **Unrestricted Boot Not Working**: Confirm `--unrestricted` was added to the correct `CLASS` line in `10_linux`.
---
### **Summary**
- **Security**: Prevents unauthorized boot parameter changes (e.g., disabling AppArmor).
- **Flexibility**: Unrestricted entries allow normal reboots without passwords.
- **Compliance**: Aligns with CIS benchmarks and similar security standards.
**Always test in a non-production environment first!**
