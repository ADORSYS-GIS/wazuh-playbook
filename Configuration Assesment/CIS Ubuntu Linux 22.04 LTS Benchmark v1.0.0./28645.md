### SSH Configuration Assessment Playbook: Disabling Weak MAC Algorithms

---

#### **Objective**  
Ensure the SSH daemon is configured to use only FIPS 140-2 approved or site-policy-compliant MAC algorithms, removing weak algorithms (e.g., MD5, SHA1, 96-bit MACs).

---

### **Step-by-Step Guide**

---

#### **Step 1: Verify Current Configuration**
1. **Check active MAC algorithms**  
   Run the command below to view the currently configured MACs:  
   ```bash
   sudo sshd -T | grep -i "macs"
   ```
   - **Expected Output**: A line like `macs [algorithm1],[algorithm2],...`  
   - **Weak MACs to Flag**:  
     `hmac-md5`, `hmac-md5-96`, `hmac-sha1`, `hmac-sha1-96`, `umac-64@openssh.com`, `umac-128@openssh.com`, and their `-etm@openssh.com` variants.

---

#### **Step 2: Backup SSH Configuration**
1. **Create a backup**  
   ```bash
   sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak_$(date +%F)
   ```

---

#### **Step 3: Edit SSH Configuration File**
1. **Open the configuration file**  
   ```bash
   sudo ${EDITOR:-nano} /etc/ssh/sshd_config
   ```
   Replace `${EDITOR}` with your preferred editor (e.g., `vim`).

2. **Locate the `MACs` line**  
   - If the line `MACs` exists, modify it.  
   - If it does not exist, add it under the `HostKeyAlgorithms` section.

3. **Update the `MACs` line**  
   Replace weak algorithms with approved ones. Example:  
   ```bash
   MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
   ```
   - **FIPS 140-2 Approved**:  
     `hmac-sha2-256`, `hmac-sha2-512` (non-`etm` variants are allowed if not in FIPS mode).  
   - **Best Practice**: Prefer Encrypt-then-MAC (`etm`) variants for better security.

4. **Comment out conflicting lines**  
   Ensure no other `MACs` lines are active (e.g., `#MACs hmac-md5`).

5. **Save and exit** the editor.

---

#### **Step 4: Validate Configuration Syntax**
1. **Check for syntax errors**  
   ```bash
   sudo sshd -t
   ```
   - If no errors, proceed.  
   - If errors occur, re-edit the file and fix typos.

---

#### **Step 5: Restart SSH Service**
1. **Reload the SSH daemon**  
   ```bash
   sudo systemctl restart sshd  # For systemd systems
   # OR
   sudo service ssh restart    # For init.d systems
   ```
   - **Warning**: Ensure you have an active session to avoid lockout. Test connectivity after restarting.

---

#### **Step 6: Post-Remediation Verification**
1. **Confirm active MACs**  
   ```bash
   sudo sshd -T | grep -i "macs"
   ```
   - **Expected Result**: Only approved algorithms (e.g., `hmac-sha2-*`) should appear.  
   - **Unexpected Result**: If weak MACs persist, revisit Step 3 and ensure no duplicates exist.

---

#### **Step 7: Test SSH Connectivity**
1. **Connect to the server**  
   Open a new terminal and verify SSH access:  
   ```bash
   ssh username@localhost
   ```
   - Resolve errors (e.g., client incompatibility) by updating client-side `ssh_config` if needed.

---

### **Additional Notes**
1. **Compliance**:  
   Confirm approved MACs with organizational policies (e.g., FIPS 140-2, PCI-DSS).  
2. **Client Compatibility**:  
   Ensure clients support the new MACs (e.g., older OpenSSH versions may lack `etm` support).  
3. **Logging**:  
   Monitor `/var/log/auth.log` for SSH handshake failures post-remediation.

---

### **Troubleshooting**
- **SSH Service Fails to Start**:  
  - Run `sudo sshd -t` to identify syntax errors.  
  - Restore the backup:  
    ```bash
    sudo cp /etc/ssh/sshd_config.bak_$(date +%F) /etc/ssh/sshd_config
    ```
- **Client Connection Failures**:  
  - Temporarily add a less strict MAC (e.g., `hmac-sha2-256`) and test incrementally.  

---

**Approvals Required**:  
- Change Advisory Board (if applicable)  
- System Owner  

**References**:  
- NIST SP 800-131A (Transitioning to Stronger Cryptographic Algorithms)  
- OpenSSH MACs Documentation: `man sshd_config`