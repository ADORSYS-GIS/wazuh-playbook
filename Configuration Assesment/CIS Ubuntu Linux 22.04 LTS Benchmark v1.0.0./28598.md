# Manual Playbook: Audit Sudo Privilege Escalation

## Purpose  
To create an audit log of users with temporary elevated privileges (via `sudo`) and their operations, enabling detection of unauthorized commands.

---

## Prerequisites  
- **Access**: Root privileges  
- **System Architecture**:  
  Confirm if 64-bit or 32-bit:  
  ```bash
  uname -m  # x86_64 = 64-bit, i*86 = 32-bit
  ```  
- **Auditd**:  
  Ensure `auditd` is installed and running:  
  ```bash
  sudo systemctl status auditd
  ```  
- **Backup**:  
  Backup existing audit rules:  
  ```bash
  sudo cp -a /etc/audit/rules.d /etc/audit/rules.d.backup
  ```  

---

## Remediation Steps  

### 1. Verify Current Audit Rules  
Check if `user_emulation` rules are already active:  
```bash
auditctl -l | grep -E 'user_emulation|execve'
```  
**Compliant**: Output includes **both** lines below (for 64-bit) or the `b32` line (for 32-bit):  
```
-a always,exit -F arch=b64 -C euid!=uid -F auid!=unset -S execve -k user_emulation  
-a always,exit -F arch=b32 -C euid!=uid -F auid!=unset -S execve -k user_emulation
```  
**Non-Compliant**: Proceed to Step 2.  

---

### 2. Create Sudo Privilege Audit Rules  
**For 64-bit systems**:  
```bash
cat << EOF | sudo tee /etc/audit/rules.d/50-user_emulation.rules
# Monitor sudo privilege escalation (64-bit + 32-bit compatibility)
-a always,exit -F arch=b64 -C euid!=uid -F auid!=1 -S execve -k user_emulation  
-a always,exit -F arch=b32 -C euid!=uid -F auid!=1 -S execve -k user_emulation  
EOF
```  

**For 32-bit systems**:  
```bash
cat << EOF | sudo tee /etc/audit/rules.d/50-user_emulation.rules
# Monitor sudo privilege escalation  
-a always,exit -F arch=b32 -C euid!=uid -F auid!=1 -S execve -k user_emulation  
EOF
```  

---

### 3. Load New Audit Rules  
```bash
sudo augenrules --load  # Compiles and activates all rules in /etc/audit/rules.d
```  

---

### 4. Verify Rules Activation  
```bash
auditctl -l | grep 'user_emulation'
```  
**Expected Output (64-bit)**:  
```
-a always,exit -F arch=b64 -C euid!=uid -F auid!=unset -S execve -k user_emulation  
-a always,exit -F arch=b32 -C euid!=uid -F auid!=unset -S execve -k user_emulation  
```  
**Expected Output (32-bit)**:  
```
-a always,exit -F arch=b32 -C euid!=uid -F auid!=unset -S execve -k user_emulation  
```  

---

### 5. Check Reboot Requirement  
```bash
if [[ $(auditctl -s | grep "enabled") =~ "2" ]]; then  
  echo "REBOOT REQUIRED to fully activate rules"  
else  
  echo "Rules loaded successfully (no reboot needed)"  
fi  
```  

---

## Validation  
1. **Test Sudo Command Auditing**:  
   ```bash
   sudo -u nonrootuser whoami  # Replace "nonrootuser" with a test account
   ausearch -k user_emulation -ts recent  # Check audit logs
   ```  
   **Expected**: Log entries showing `execve` calls with `auid` matching the test user.  

2. **Verify Rule Persistence**:  
   Reboot if required, then re-run:  
   ```bash
   auditctl -l | grep 'user_emulation'
   ```  

---

## References  
- `man auditd`, `man audit.rules`  
- CIS Benchmark: Ensure auditd Collects System Administrator Actions (Section 4.1.6)